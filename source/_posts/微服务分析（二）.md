title: 微服务分析（二）
date: 2018-01-17 13:43:14
tags: SOA

---

## 使用API网关构建微服务

引入一个简单的场景，以一个亚马逊购物网站的手机APP订单查看界面来举例
如果是一个单体应该，那么所有的界面需要获取信息都通过单体应用统一一个地址提供多个Service API获取，但是转变为微服务架构后可以看到对于会员管理，商品管理，订单管理，财务结算管理等都已经拆分为不同的微服务模块，需要从不同的服务地址调用不同的微服务模块提供的Service API来返回数据

#### 对于客户端和微服务模块间点对点直接通讯有三个问题

**1. 问题一：**客户端需求和每个微服务暴露的细粒度API不匹配
**2. 问题二：**部分服务使用的协议对web并不友好，如二进制RPC或AMQP消息等
**3. 问题三：**使得微服务难以重构，如服务拆分或服务组合的场景

#### 从传统的ESB能力对上面三个问题作一个说明
**第一可能涉及到细粒度的API组合，类似组合无法做**
**第二可能存在协议转换的问题需要解决**
**第三服务透明的问题，需要对客户端提供一个统一的服务目录以使底层服务透明**

由于以上问题引入API网关的概念，在此强调**API网关即是微服务架构里面的轻量级服务总线，解决服务监控和治理相关问题**



> API网关是一个服务器，也可以说是进入系统的唯一节点，这与面向对象设计模式的Facade模式很像
> API网关封装内系统的架构，并且提供API给各个客户端，它还可以具有授权，监控，负载均衡，缓存，请求分片和管理，静态响应处理等功能

> API网关负责服务请求路由，组合及协议转换。客户端的所有请求都首先经过API网关，然后由它将请求路由到合适的微服务。
> API网关经常会通过调用多个微服务并合并结果来处理一个请求。它可以在web协议（HTTP与websocket）与内部使用的非web友好协议之间转换

> API网关还能为每个客户端提供一个定制的API。通常，它会向移动客户端暴露一个粗粒度的API.以产品详情的场景为例，API网关可以提供一个端点（/productdetails?productid=xxx），它使移动客户端可以通过一个请求获取所有的产品详情。Api网关通过调用各个服务（产品信息，推荐，评论等）并合并结果来处理请求

## API网关的优点和缺点

对于API网关的优点，类似传统ESB企业服务总线的优点，即实现服务透明，同时对于服务运行过程中的日志，安全，路由，缓存等问题进行统一配置和处理，而不需要每个微服务API实现时都去考虑，如开源的dubbo服务总线及可以看做是一个API网关的实现

API网关和ESB的重要区别在于API网关更加轻量和高性能，不需要考虑太多遗留系统和诸多协议的适配，其次也不要考虑服务集成过程中的大量数据转换和映射，为了提升服务网关的性能，一般API网关在实现过程中不会详细记录数据传输日志，或者dubbo架构数据传输根本就不经过API网关
**
API网关的最大优点是封装了应用程序的内部结构**

客户端只需要同网关交互，而不必调用特定的服务。API网关也有不足之处，增加了一个我们必须开发，部署和维护的高可用组件，还有一个风险，API网关变成了开发瓶颈
**简单来说，在期望中的去中心化和全分布式架构中，网关又成了一个中心点或瓶颈点，由于这个原因我们在网关设计的时候必须考虑即使API Gateway宕机也不要影响服务的调用和运行**

## API网关的设计和开发

**API网关构建需要支持异步、I/O非阻塞的平台，有多种不同的技术可以实现一个可扩展的API网关**
**JVM上基于NIO的框架**，比如netty,vertx,spring reactor或Jboss undertow中的一种
**非JVM上选Node.js**，基于Chrome JavaScript引擎构建

**另一个方案是NGINX plus**,NGINX plus提供了一个成熟的，可扩展的，高性能的web服务器和一个易于部署的，可配置可编程的反向代理
NGINX plus可以管理身份验证，访问控制，负载均衡，缓存响应，并提供应用程序可感知的健康检查和监控

**对于API网关需要实现底层多个细粒度的API组合的场景，推荐采用响应式编程模型而不是传统的异步回调方法组合代码。原因是采用回调方式导致代码混乱，很难控制API组合本身可能存在并行和先后调用的错乱**

基于微服务的应用是一个分布式系统，必须使用一种进程间的通信机制
###### 一种是使用异步的、基于消息传递的机制，诸如JMS或AMQP消息代理，没有代理的zeromq，服务间直接通讯
###### 另一种是HTTP或thrift这样的同步机制，通常一个系统会同时使用异步和同步两种类型，甚至使用同一种类型的多种实现
###### 总之API网关需要支持多种通信机制

**注：如果服务是同步调用可以看到微服务模块之间是没有彻底解耦的，如果A依赖B提供的API，如果B提供的服务不可用将直接影响A不可用。除非同步服务调用在API网关层或客户端做了相应的缓存。因此，在微服务上建议选择异步方式进行**

对于多数基于微服务的应用程序而言，实现API网关，将其作为系统的唯一入口很有必要，API网关负责请求路由，组合及协议转换，为每个应用程序客户端提供一个定制的API。API网关还可以通过返回缓存数据或默认数据屏蔽后端服务失败



